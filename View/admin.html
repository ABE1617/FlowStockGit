<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FlowStock Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f6f8;
    }

    .sidebar {
      width: 220px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background-color: #343a40;
      padding-top: 20px;
    }

    .sidebar a {
      padding: 12px 20px;
      display: block;
      color: #ffffff;
      text-decoration: none;
    }

    .sidebar a:hover {
      background-color: #495057;
    }

    .dashboard {
      margin-left: 240px;
      padding: 40px 20px;
      max-width: 1100px;
    }

    .table th,
    .table td {
      vertical-align: middle;
    }

    .form-inline {
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <a href="#">üè† Home Page</a>
  <a href="#">üë• Clients</a>
  <a href="#">üö® Alerts</a>
</div>

<!-- Main Content -->
<div class="container dashboard">
  <h2 class="mb-4">FlowStock Admin Dashboard</h2>

  <div class="form-inline mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Search users...">
    <select id="filterRole" class="form-select">
      <option value="">All Roles</option>
      <option value="admin">Admin</option>
      <option value="user">User</option>
    </select>
    <button class="btn btn-success" onclick="showUserForm()">Add User</button>
  </div>

  <table class="table table-hover table-bordered">
    <thead class="table-dark">
      <tr>
        <th>ID</th><th>Name</th><th>Store</th><th>Email</th><th>Birthday</th>
        <th>Role</th><th>Status</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="userTableBody"></tbody>
  </table>
</div>

<!-- User Form Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="userForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userModalLabel">Add/Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="id">
        <input type="text" name="first_name" class="form-control mb-2" placeholder="First Name" required>
        <input type="text" name="last_name" class="form-control mb-2" placeholder="Last Name" required>
        <input type="text" name="store_name" class="form-control mb-2" placeholder="Store Name">
        <input type="email" name="email" class="form-control mb-2" placeholder="Email" required>
        <input type="date" name="birthday" class="form-control mb-2">
        <select name="role" class="form-select mb-2">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
        <input type="date" name="subscription_start" class="form-control mb-2" placeholder="Start Date">
<input type="text" name="subscription_duration" class="form-control mb-2" placeholder="Duration (e.g., 10 days, 1 month)">

        <label><input type="checkbox" name="is_active"> Active</label>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const token = localStorage.getItem('jwtToken');
  const tbody = document.getElementById('userTableBody');
  const searchInput = document.getElementById('searchInput');
  const filterRole = document.getElementById('filterRole');
  const userModal = new bootstrap.Modal(document.getElementById('userModal'));
  const userForm = document.getElementById('userForm');

  let users = [];

  async function loadUsers() {
    const res = await axios.get('/api/admin/users', {
      headers: { Authorization: `Bearer ${token}` }
    });
    users = res.data;
    renderUsers();
  }

  function renderUsers() {
    tbody.innerHTML = '';
    const query = searchInput.value.toLowerCase();
    const roleFilter = filterRole.value;

    users
      .filter(u => u.email.toLowerCase().includes(query) && (!roleFilter || u.role === roleFilter))
      .forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.id}</td>
          <td>${user.first_name} ${user.last_name}</td>
          <td>${user.store_name}</td>
          <td>${user.email}</td>
          <td>${user.birthday}</td>
          <td>${user.role}</td>
          <td>${user.is_active ? 'Active' : 'Inactive'}</td>
          <td>
            <button class="btn btn-sm btn-info" onclick="editUser(${user.id})">Edit</button>
            <button class="btn btn-sm btn-${user.is_active ? 'secondary' : 'success'}" onclick="toggleActivation(${user.id})">
              ${user.is_active ? 'Deactivate' : 'Activate'}
            </button>
            <button class="btn btn-sm btn-warning" onclick="toggleRole(${user.id}, '${user.role}')">Toggle Role</button>
            <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
  }

  async function toggleActivation(id) {
    await axios.post(`/api/admin/activate/${id}`, {}, {
      headers: { Authorization: `Bearer ${token}` }
    });
    loadUsers();
  }

  async function toggleRole(id, currentRole) {
    const newRole = currentRole === 'admin' ? 'user' : 'admin';
    await axios.post(`/api/admin/role/${id}`, { role: newRole }, {
      headers: { Authorization: `Bearer ${token}` }
    });
    loadUsers();
  }

  async function deleteUser(id) {
    if (confirm("Are you sure you want to delete this user?")) {
      await axios.delete(`/api/admin/delete/${id}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      loadUsers();
    }
  }

  function showUserForm() {
    userForm.reset();
    userForm.id.value = '';
    userModal.show();
  }

  function editUser(id) {
    const user = users.find(u => u.id === id);
    if (user) {
      userForm.id.value = user.id;
      userForm.first_name.value = user.first_name;
      userForm.last_name.value = user.last_name;
      userForm.store_name.value = user.store_name;
      userForm.email.value = user.email;
      userForm.birthday.value = user.birthday;
      userForm.role.value = user.role;
      userForm.is_active.checked = user.is_active;
      userModal.show();
    }
  }

  userForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(userForm);
    const data = Object.fromEntries(formData.entries());
    data.is_active = formData.get('is_active') === 'on';

    if (!data.id) delete data.id;

    try {
      if (data.id) {
        await axios.put(`/api/admin/user/${data.id}`, data, {
          headers: { Authorization: `Bearer ${token}` }
        });
      } else {
        await axios.post(`/api/admin/user`, data, {
          headers: { Authorization: `Bearer ${token}` }
        });
      }

      userModal.hide();
      loadUsers();
    } catch (err) {
      console.error("Error saving user:", err.response?.data || err.message);
      const msg = err.response?.data?.message || "Error saving user.";
      alert(msg);
    }
  });

  searchInput.addEventListener('input', renderUsers);
  filterRole.addEventListener('change', renderUsers);

  loadUsers();
</script>
</body>
</html>
